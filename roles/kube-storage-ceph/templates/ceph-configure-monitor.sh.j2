#! /bin/bash

set -e

# see http://docs.ceph.com/docs/master/install/manual-deployment/

# copy the main keyring to tmp and set correct permissions so we can use monmaptool
cp -f {{ kube_storage_ceph_scriptdir }}/ceph.mon.keyring /tmp/ceph.mon.keyring
chown ceph.ceph /tmp/ceph.mon.keyring

# Generate a monitor map using the hostname(s), host IP address(es) and the FSID. Save it as /tmp/monmap
monmaptool --create {% for monitor in groups['kube_ceph_monitors'] %}--add {{ monitor }} {{ hostvars[monitor].internal_ip }} {% endfor %}--fsid {{ kube_storage_ceph_cluster_uuid }} /tmp/monmap

# Create a default data directory (or directories) on the monitor host(s)
sudo -u ceph mkdir /var/lib/ceph/mon/{{ kube_storage_ceph_cluster_name }}-{{ ansible_hostname }}

# Populate the monitor daemon(s) with the monitor map and keyring
sudo -u ceph ceph-mon --cluster {{ kube_storage_ceph_cluster_name }} \
  --mkfs --id {{ ansible_hostname }} --monmap /tmp/monmap --keyring /tmp/ceph.mon.keyring

# touch the done file to mark that the monitor is created and ready to be started
touch /var/lib/ceph/mon/{{ kube_storage_ceph_cluster_name }}-{{ ansible_hostname }}/done

rm -f /tmp/ceph.mon.keyring
rm -f /tmp/monmap

# can now start it using
# systemctl start ceph-mon@kube3
